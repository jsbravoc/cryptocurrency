/*! cryptocurrency 2021-05-22 */
const{validationResult}=require("express-validator"),{findByAddress}=require("../controllers/common"),{TYPE}=require("../utils/constants"),{ERRORS}=require("../utils/errors"),{SEVERITY,logFormatted}=require("../utils/logger"),validate=r=>(a,o,t)=>Promise.all(r.map(r=>r.run(a))).then(()=>{const r=validationResult(a);if(r.isEmpty())return t();const e=[];(r.array()||[]).forEach(r=>r.msg&&e.push(r.msg)),o.status(400).json({errors:0<e.length?e:r.array()})}),createErrorObj=(r,{error:e,location:a,params:o})=>{const t={};return e.errorCode&&(t.errorCode=e.errorCode),o.param&&(o.parameter=o.param),e.error&&(t.error=e.error(r,o)),e.msg&&(t.msg=e.msg(r,o)),t.location=a||"body",o.param&&(t.param=o.param),o.value&&(t.value=o.value),logFormatted(`Validation error with code ${t.errorCode} - ${t.error}`,SEVERITY.WARN),{...t}},createError=(r,e,{error:a,location:o,params:t})=>{t=createErrorObj(r,{error:a,location:o,params:t});return e.status(400).json({errors:[{...t}]})},validateAssetExistence=(s,l,i,n,d,{location:E=null,param:u=null}={})=>{let r,e;switch(l=(l+"").trim(),s){case TYPE.TRANSACTION:r=ERRORS.TRANSACTION,e="signature";break;case TYPE.USER:r=ERRORS.USER,e="address";break;default:return Promise.reject(`Missing type ${s}`)}return l&&""!==l?findByAddress(s,l,!1,!1,d).then(r=>{var e=i&&null===r,a=!i&&null!==r;if(e||a){var o=`${s.toProperCase()} with address {${l}} ${e?"does not":"already"} exist${e?"":"s"}`;logFormatted(o,SEVERITY.ERROR);let r;switch(s){case TYPE.TRANSACTION:e?r={error:ERRORS.TRANSACTION.INPUT.TRANSACTION_DOES_NOT_EXIST,location:E||"params",params:{signature:l,param:u||"address",value:l}}:a&&(r={error:ERRORS.TRANSACTION.INPUT.TRANSACTION_EXISTS,location:E||"body",params:{signature:l,param:u||"signature",value:l}});break;case TYPE.USER:e?r={error:ERRORS.USER.INPUT.USER_DOES_NOT_EXIST,location:E||"query",params:{address:l,param:u||"address",value:l}}:a&&(r={error:ERRORS.USER.INPUT.USER_EXISTS,location:E||"body",params:{address:l,param:u||"address",value:l}})}return Promise.reject(()=>createError(n,d,r))}const t={};return t[s]=r,Promise.resolve(t)}):Promise.reject(()=>createError(n,d,{error:r.INPUT.NO_INPUT,location:E,params:{property:e,param:e,value:null}}))};module.exports.validateAssetExistence=validateAssetExistence,module.exports.validate=validate,module.exports.createError=createError,module.exports.createErrorObj=createErrorObj;