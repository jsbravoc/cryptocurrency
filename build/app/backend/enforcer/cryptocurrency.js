/*! cryptocurrency 2021-05-20 */
const{findByAddress,findAllAssets,buildAssetTransaction,putBatch}=require("../controllers/common"),{TYPE,HTTP_METHODS}=require("../utils/constants"),{logFormatted,SEVERITY}=require("../utils/logger"),updateInvalidTransaction=(a,n)=>findByAddress(TYPE.TRANSACTION,a,!1,!1,n).then(a=>a&&(!a.pending&&a.checkValidity()!==a.valid||a.pending&&!a.checkValidity())?(a.valid=a.checkValidity(),{transactionObj:a,assetObj:buildAssetTransaction(TYPE.TRANSACTION,HTTP_METHODS.PUT,a)}):null),updateInvalidUserTransactions=(a,n,i)=>findByAddress(TYPE.USER,a,!1,!1,i).then(s=>{const e=[],t=[];let r=!1;return s&&((Array.isArray(n)&&0<n.length?(s.lastest_transactions||[]).filter(a=>-1<n.indexOf(a)):s.lastest_transactions||[]).forEach(a=>{e.push(updateInvalidTransaction(a,i).then(a=>{var n;a&&({transactionObj:n,assetObj:a}=a,r=!0,s.removeInvalidTransaction(n),t.push(a))}))}),(Array.isArray(n)&&0<n.length?(s.pending_transactions||[]).filter(a=>-1<n.indexOf(a)):s.pending_transactions||[]).forEach(n=>{e.push(updateInvalidTransaction(n,i).then(a=>{a&&({assetObj:a}=a,r=!0,s.removePendingTransaction(n),t.push(a))}))})),Promise.all(e).then(()=>(r&&t.push(buildAssetTransaction(TYPE.USER,HTTP_METHODS.PUT,s)),t))}),updateInvalidUsersTransactions=(s,a=null,e=null,t)=>{const r=[],n=[];return Array.isArray(a)&&0<a.length?a.forEach(a=>{n.push(findByAddress(TYPE.USER,a,!1,!1,t))}):(logFormatted("Warning: Enforcer called without users query parameter, increasing load significantly",SEVERITY.WARN),n.push(findAllAssets(TYPE.USER,s,void 0,!1,!1,t))),Promise.all(n).then(a=>{const n=[].concat.apply([],a);return n.forEach(a=>{a.address&&r.push(updateInvalidUserTransactions(a.address,e,t))}),Promise.all(r).then(a=>{a=[].concat.apply([],a);if(0<a.length)return putBatch(HTTP_METHODS.PUT,s,a)})})},enforceValidTransactionsMiddleware=(a,n,s)=>{let e,t;return a.query.users&&(e=a.query.users.split(",")),a.query.transactions&&(t=a.query.transactions.split(",")),updateInvalidUsersTransactions("[ENFORCER]",e,t,n).then(()=>s()).catch(a=>{logFormatted("Enforcer failed with error",SEVERITY.ERROR,a),s()})};module.exports.updateInvalidTransaction=updateInvalidTransaction,module.exports.updateInvalidUserTransactions=updateInvalidUserTransactions,module.exports.updateInvalidUsersTransactions=updateInvalidUsersTransactions,module.exports.enforceValidTransactionsMiddleware=enforceValidTransactionsMiddleware;