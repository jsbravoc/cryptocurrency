const{findByAddress,findAllAssets,buildAssetTransaction,putBatch}=require("../controllers/common"),{TYPE,HTTP_METHODS}=require("../utils/constants"),{logFormatted,SEVERITY}=require("../utils/logger"),{createError}=require("../validators/common"),{ERRORS}=require("../utils/errors"),updateInvalidTransaction=(a,r)=>findByAddress(TYPE.TRANSACTION,a,!1,r).then(a=>a&&(!a.pending&&a.checkValidity()!==a.valid||a.pending&&!a.checkValidity())?(a.valid=a.checkValidity(),{transactionObj:a,assetObj:buildAssetTransaction(TYPE.TRANSACTION,HTTP_METHODS.PUT,a)}):null),updateInvalidUserTransactions=(a,r,i)=>findByAddress(TYPE.USER,a,!1,i).then(e=>{const n=[],s=[];let t=!1;return e&&((Array.isArray(r)&&0<r.length?(e.latest_transactions||[]).filter(a=>-1<r.indexOf(a)):e.latest_transactions||[]).forEach(a=>{n.push(updateInvalidTransaction(a,i).then(a=>{var r;a&&({transactionObj:r,assetObj:a}=a,t=!0,e.removeInvalidTransaction(r),s.push(a))}))}),(Array.isArray(r)&&0<r.length?(e.pending_transactions||[]).filter(a=>-1<r.indexOf(a)):e.pending_transactions||[]).forEach(r=>{n.push(updateInvalidTransaction(r,i).then(a=>{a&&({assetObj:a}=a,t=!0,e.removePendingTransaction(r),s.push(a))}))})),Promise.all(n).then(()=>(t&&s.push(buildAssetTransaction(TYPE.USER,HTTP_METHODS.PUT,e)),s))}),updateInvalidUsersTransactions=(e,a=null,n=null,s)=>{const t=[],r=[];return Array.isArray(a)&&0<a.length?a.forEach(a=>{r.push(findByAddress(TYPE.USER,a,!1,s))}):(logFormatted("Warning: Enforcer called without users query parameter, increasing load significantly",SEVERITY.WARN),r.push(findAllAssets(TYPE.USER,e,void 0,!1,s))),Promise.all(r).then(a=>{const r=[].concat.apply([],a);return r.forEach(a=>{a.address&&t.push(updateInvalidUserTransactions(a.address,n,s))}),Promise.all(t).then(a=>{a=[].concat.apply([],a);if(0<a.length)return putBatch(HTTP_METHODS.PUT,e,a)})})},enforceValidTransactionsMiddleware=(r,e,a)=>{let n,s;return r.query.users&&(n=r.query.users.split(",")),r.query.transactions&&(s=r.query.transactions.split(",")),updateInvalidUsersTransactions("[ENFORCER]",n,s,e).then(()=>a()).catch(a=>(logFormatted("Enforcer failed with error",SEVERITY.ERROR,a.errno||a.message),createError(r,e,{error:ERRORS.SAWTOOTH.UNAVAILABLE,statusCode:503,noLocation:!0})))};module.exports.updateInvalidTransaction=updateInvalidTransaction,module.exports.updateInvalidUserTransactions=updateInvalidUserTransactions,module.exports.updateInvalidUsersTransactions=updateInvalidUsersTransactions,module.exports.enforceValidTransactionsMiddleware=enforceValidTransactionsMiddleware;