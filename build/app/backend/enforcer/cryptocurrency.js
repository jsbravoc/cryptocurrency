const{findByAddress,findAllObjects,buildObjectTransaction,putBatch}=require("../controllers/common"),{TYPE,HTTP_METHODS}=require("../utils/constants"),{logFormatted,SEVERITY}=require("../utils/logger"),{createError}=require("../validators/common"),{ERRORS}=require("../utils/errors"),updateInvalidTransaction=(r,a,n=0)=>findByAddress(TYPE.TRANSACTION,r,!1,a).then(r=>r&&!r.checkValidity()?(r.valid=r.checkValidity(),{transactionObj:r,txObj:buildObjectTransaction(TYPE.TRANSACTION,HTTP_METHODS.PUT,r)}):null),updateInvalidUserTransactions=(r,a,i)=>findByAddress(TYPE.USER,r,!1,i).then(n=>{const e=[],t=[];let s=!1;return n&&((Array.isArray(a)&&0<a.length?(n.latest_transactions||[]).filter(r=>-1<a.indexOf(r)):n.latest_transactions||[]).forEach(r=>{e.push(updateInvalidTransaction(r,i,!0).then(r=>{var a;r&&({transactionObj:a,txObj:r}=r,s=!0,n.removeInvalidTransaction(a),t.push(r))}))}),(Array.isArray(a)&&0<a.length?(n.pending_transactions||[]).filter(r=>-1<a.indexOf(r)):n.pending_transactions||[]).forEach(a=>{e.push(updateInvalidTransaction(a,i,!1).then(r=>{r&&({txObj:r}=r,s=!0,n.removePendingTransaction(a),t.push(r))}))})),Promise.all(e).then(()=>(s&&t.push(buildObjectTransaction(TYPE.USER,HTTP_METHODS.PUT,n)),t))}),updateInvalidUsersTransactions=(n,r=null,e=null,t)=>{const s=[],a=[];return Array.isArray(r)&&0<r.length?r.forEach(r=>{a.push(findByAddress(TYPE.USER,r,!1,t))}):(logFormatted("Warning: Enforcer called without users query parameter, increasing load significantly",SEVERITY.WARN),a.push(findAllObjects(TYPE.USER,n,void 0,!1,t))),Promise.all(a).then(r=>{const a=[].concat.apply([],r);return a.forEach(r=>{r.address&&s.push(updateInvalidUserTransactions(r.address,e,t))}),Promise.all(s).then(r=>{r=[].concat.apply([],r);if(0<r.length)return putBatch(HTTP_METHODS.PUT,n,r)})})},enforceValidTransactionsMiddleware=(a,n,r)=>{let e,t;return a.query.users&&(e=a.query.users.split(",")),a.query.transactions&&(t=a.query.transactions.split(",")),updateInvalidUsersTransactions("[ENFORCER]",e,t,n).then(()=>r()).catch(r=>(logFormatted("Enforcer failed with error",SEVERITY.ERROR,r.errno||r.message),createError(a,n,{error:ERRORS.SAWTOOTH.UNAVAILABLE,statusCode:503,noLocation:!0})))};module.exports.updateInvalidTransaction=updateInvalidTransaction,module.exports.updateInvalidUserTransactions=updateInvalidUserTransactions,module.exports.updateInvalidUsersTransactions=updateInvalidUsersTransactions,module.exports.enforceValidTransactionsMiddleware=enforceValidTransactionsMiddleware;