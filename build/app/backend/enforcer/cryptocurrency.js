/*! cryptocurrency 2021-05-11 */
const Transaction=require("../models/Transaction"),User=require("../models/User"),{findByAddress,findAllAssets,buildAssetTransaction,putBatch}=require("../controllers/common"),{TYPE,HTTP_METHODS}=require("../utils/constants"),{logFormatted,SEVERITY}=require("../utils/logger"),updateInvalidTransaction=a=>findByAddress(TYPE.TRANSACTION,a).then(a=>a&&a.checkValidity()!==a.valid?(a.valid=a.checkValidity(),{transactionObj:a,assetObj:buildAssetTransaction(TYPE.TRANSACTION,HTTP_METHODS.PUT,a)}):null),updateInvalidUserTransactions=a=>findByAddress(TYPE.USER,a).then(e=>{const s=[],n=[];let t=!1;return e&&(e.lastest_transactions||[]).forEach(a=>{s.push(updateInvalidTransaction(a).then(a=>{var s;a&&({transactionObj:s,assetObj:a}=a,t=!0,e.removeInvalidTransaction(s),n.push(a))}))}),Promise.all(s).then(()=>(t&&n.push(buildAssetTransaction(TYPE.USER,HTTP_METHODS.PUT,e)),n))}),updateInvalidUsersTransactions=s=>{const e=[];return findAllAssets(TYPE.USER,s).then(a=>(a.forEach(a=>{a.address&&e.push(updateInvalidUserTransactions(a.address,s))}),Promise.all(e).then(a=>{a=[].concat.apply([],a);if(0<a.length)return putBatch(HTTP_METHODS.PUT,s,a)})))},enforceValidTransactionsMiddleware=(a,e,s)=>updateInvalidUsersTransactions("[ENFORCER]").then(a=>(a&&(a.payload||[]).forEach(({args:a})=>{var{transaction:s}=a;switch((s=JSON.parse(s)).type){case TYPE.TRANSACTION:e.locals.transaction||(e.locals.transaction={}),e.locals.transaction[s.signature]=new Transaction(s).toObject(!1,!0);break;case TYPE.USER:e.locals.user||(e.locals.user={}),e.locals.user[s.address]=new User(s).toObject(!0,!0)}}),s())).catch(a=>{logFormatted("Enforcer failed with error",SEVERITY.ERROR,a),s()});module.exports.updateInvalidTransaction=updateInvalidTransaction,module.exports.updateInvalidUserTransactions=updateInvalidUserTransactions,module.exports.updateInvalidUsersTransactions=updateInvalidUsersTransactions,module.exports.enforceValidTransactionsMiddleware=enforceValidTransactionsMiddleware;