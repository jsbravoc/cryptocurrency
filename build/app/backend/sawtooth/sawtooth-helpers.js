/*! cryptocurrency 2021-05-20 */
const _=require("lodash"),secp256k1=require("secp256k1"),crypto=require("crypto"),{protobuf}=require("sawtooth-sdk"),axios=require("axios");axios.defaults.timeout=1e4;const privateKey=Buffer.from(process.env.SAWTOOTH_PRIVATE_KEY.slice(2),"hex"),publicKey=secp256k1.publicKeyCreate(privateKey),publicKeyHex=Buffer.from(publicKey).toString("hex"),hash512=e=>crypto.createHash("sha512").update(e).digest("hex"),hash256=e=>crypto.createHash("sha256").update(e).digest("hex"),sign=(e,t)=>{e=hash256(e);return Buffer.from(secp256k1.ecdsaSign(Uint8Array.from(Buffer.from(e,"hex")),Uint8Array.from(t)).signature).toString("hex")};function buildTransaction(e,t,a,r,i){i=Buffer.from(i,"utf8"),a=protobuf.TransactionHeader.encode({familyName:e,familyVersion:t,inputs:a,outputs:r,signerPublicKey:publicKeyHex,batcherPublicKey:publicKeyHex,dependencies:[],payloadSha512:hash512(i),nonce:crypto.randomBytes(32).toString("hex")}).finish(),r=sign(a,privateKey);return protobuf.Transaction.create({header:a,headerSignature:r,payload:i})}function buildBatch(e){var t=protobuf.BatchHeader.encode({signerPublicKey:publicKeyHex,transactionIds:e.map(e=>e.headerSignature)}).finish(),a=sign(t,privateKey),e=protobuf.Batch.create({header:t,headerSignature:a,transactions:e});return protobuf.BatchList.encode({batches:[e]}).finish()}module.exports.sendTransaction=async function(e){var t=buildBatch(_.map(e,e=>{var{transactionFamily:t,transactionFamilyVersion:a,inputs:r,outputs:i,payload:e}=e;return buildTransaction(t,a,r,i,e)})),e={headers:{"Content-Type":"application/octet-stream"},timeout:process.env.SAWTOOTH_REST_TIMEOUT||5e3};return axios.post(`${process.env.SAWTOOTH_REST}/batches`,t,e)},module.exports.queryState=async function(e){let t;try{t=await axios.get(`${process.env.SAWTOOTH_REST}/state/${e}`,{headers:{"Content-Type":"application/json"}})}catch(e){return null}if(!t||!t.data||!t.data.data)return null;const a=Buffer.from(t.data.data,"base64");return JSON.parse(a.toString("utf8"))};