

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> controllers/common.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-MongoUtils.html">MongoUtils</a></li></ul><h3>Classes</h3><ul><li><a href="Asset.html">Asset</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="Transaction.html">Transaction</a></li><li><a href="User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_putAsset">_putAsset</a></li><li><a href="global.html#_updateTransaction">_updateTransaction</a></li><li><a href="global.html#_updateUser">_updateUser</a></li><li><a href="global.html#buildAssetTransaction">buildAssetTransaction</a></li><li><a href="global.html#buildBatch">buildBatch</a></li><li><a href="global.html#createTransaction">createTransaction</a></li><li><a href="global.html#expandSupportingTransactions">expandSupportingTransactions</a></li><li><a href="global.html#findAllAssets">findAllAssets</a></li><li><a href="global.html#findByAddress">findByAddress</a></li><li><a href="global.html#findTransaction">findTransaction</a></li><li><a href="global.html#findUser">findUser</a></li><li><a href="global.html#getAddress">getAddress</a></li><li><a href="global.html#getSupportingTransactions">getSupportingTransactions</a></li><li><a href="global.html#getTransactionAddress">getTransactionAddress</a></li><li><a href="global.html#getTransactionByAddress">getTransactionByAddress</a></li><li><a href="global.html#getTransactions">getTransactions</a></li><li><a href="global.html#getUserAddress">getUserAddress</a></li><li><a href="global.html#getUserByAddress">getUserByAddress</a></li><li><a href="global.html#getUsers">getUsers</a></li><li><a href="global.html#hash512">hash512</a></li><li><a href="global.html#http">http</a></li><li><a href="global.html#inputValidation">inputValidation</a></li><li><a href="global.html#normalizePort">normalizePort</a></li><li><a href="global.html#onError">onError</a></li><li><a href="global.html#port">port</a></li><li><a href="global.html#putAsset">putAsset</a></li><li><a href="global.html#putBatch">putBatch</a></li><li><a href="global.html#server">server</a></li><li><a href="global.html#updateTransaction">updateTransaction</a></li><li><a href="global.html#validate">validate</a></li><li><a href="global.html#validateAssetExistence">validateAssetExistence</a></li><li><a href="global.html#validateExistingTransaction">validateExistingTransaction</a></li><li><a href="global.html#validatePendingTransaction">validatePendingTransaction</a></li><li><a href="global.html#validateTransactionAddress">validateTransactionAddress</a></li><li><a href="global.html#validateTransactionUpdateRequest">validateTransactionUpdateRequest</a></li><li><a href="global.html#validateUserCreation">validateUserCreation</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>controllers/common.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable camelcase */
const _ = require("lodash");
const crypto = require("crypto");
const { default: axios } = require("axios");
const {
  ADDRESS_PREFIX,
  HTTP_METHODS,
  TYPE,
  TRANSACTION_FAMILY,
  LOCAL_ADDRESS,
} = require("../utils/constants");
const { SEVERITY, logFormatted } = require("../utils/logger");

const { queryState, sendTransaction } = require("../sawtooth/sawtooth-helpers");
const Transaction = require("../models/Transaction");
const User = require("../models/User");
const Asset = require("../models/Asset");

//#region [AUXILIARY FUNCTIONS]

/**
 * Generates the sha512 of a string
 *
 * @param {String} x - The string to hash.
 * @returns {String} The hashed string.
 */
const hash512 = (x) => crypto.createHash("sha512").update(x).digest("hex");

/**
 * Generates the address of a key with a predefined length
 *
 * @param {String} key - The string to hash and generate an address,
 * @param {Number} [length] - The length of the resulting address (used to substring the string).
 * @returns {String} The hashed string with the desired length.
 */
const getAddress = (key, length = 64) => hash512(key).slice(0, length);

const PREFIX = getAddress(TRANSACTION_FAMILY, 6);

/**
 * Generates the address of a transaction
 *
 * @param {String} txid - Unique transaction id.
 * @returns {String} The generated address of the transaction.
 */
const getTransactionAddress = (txid) =>
  PREFIX + ADDRESS_PREFIX.TRANSACTION + getAddress(txid, 62);

/**
 * Generates the address of a user.
 *
 * @param {String} userId - Unique user id.
 * @returns {String} The generated address of the user.
 */
const getUserAddress = (userId) =>
  PREFIX + ADDRESS_PREFIX.USER + getAddress(userId, 62);

//#endregion

//#region [SAWTOOTH REST API FUNCTIONS]

/**
 * Finds and returns an asset in the blockchain.
 *
 * @param {String} type - Type of asset, such as TRANSACTION or USER ( @see TYPE ).
 * @param {String} txid - Asset unique identification (before calculated address).
 * @param {Boolean} [removeSignature] - Boolean that indicates if the signature should be removed.
 * @param {Boolean} [removeType] - Boolean that indicates if the type should be removed.
 * @param {Object} [res] - Express.js response object, used to access locals.
 * @return {Promise} Promise of the asset if found or null if not found.
 */
const findByAddress = (
  type,
  txid,
  removeSignature = false,
  removeType = false,
  res = null
) => {
  let addressToQuery;

  switch (type) {
    case TYPE.TRANSACTION:
      if (
        res &amp;&amp;
        res.locals &amp;&amp;
        res.locals.transaction &amp;&amp;
        res.locals.transaction[txid]
      )
        return Promise.resolve(
          new Transaction(res.locals.transaction[txid]).toObject(
            removeSignature,
            removeType
          )
        );
      addressToQuery = getTransactionAddress(txid);
      break;
    case TYPE.USER:
      if (res &amp;&amp; res.locals &amp;&amp; res.locals.user &amp;&amp; res.locals.user[txid])
        return Promise.resolve(
          new User(res.locals.user[txid]).toObject(removeSignature, removeType)
        );
      addressToQuery = getUserAddress(txid);
      break;
  }
  return queryState(addressToQuery).then((response) => {
    if (!response) {
      return null;
    }
    switch (type) {
      case TYPE.TRANSACTION:
        if (res &amp;&amp; res.locals) {
          if (!res.locals.transaction) res.locals.transaction = {};
          res.locals.transaction[response.signature] = new Transaction(
            response
          );
        }
        response = new Transaction(response).toObject(
          removeSignature,
          removeType
        );

        break;
      case TYPE.USER:
        if (res &amp;&amp; res.locals) {
          if (!res.locals.user) res.locals.user = {};
          res.locals.user[response.address] = new User(response);
        }
        response = new User(response).toObject(removeSignature, removeType);
        break;
    }
    return response;
  });
};

/**
 * Finds and returns all assets of a type.
 * @pre A request to an endpoint of an asset is made. The endpoint must be GET /{asset}
 * @param {String} type - Type of asset, such as TRANSACTION or USER ( @see TYPE ).
 * @param {String} source - Endpoint source that invoked function (used for logging).
 * @param {Number} [limit] - Maximum number of assets to return.
 * @param {Boolean} [removeSignature] - Boolean that indicates if the signature should be removed.
 * @param {Boolean} [removeType] - Boolean that indicates if the type should be removed.
 * @param {Object} [res] - Express.js response object, used to access locals.
 * @returns {Promise} - Promise of the assets returned.
 */
const findAllAssets = (
  type,
  source,
  limit = 0,
  removeSignature = false,
  removeType = false,
  res = null
) => {
  let assetName;
  let addressPrefix;
  switch (type) {
    case TYPE.TRANSACTION:
      assetName = "transaction";
      addressPrefix = ADDRESS_PREFIX.TRANSACTION;
      break;
    case TYPE.USER:
      assetName = "user";
      addressPrefix = ADDRESS_PREFIX.USER;
      break;
  }
  const params = {
    headers: { "Content-Type": "application/json" },
  };
  return axios
    .get(
      `${process.env.SAWTOOTH_REST}/state?address=${PREFIX + addressPrefix}${
        limit !== 0 ? `&amp;limit=${limit}` : ""
      }`,
      params
    )
    .then((query) => {
      const assetList = _.chain(query.data.data)
        .filter(
          (item) => !_.isEmpty(JSON.parse(Buffer.from(item.data, "base64")))
        )
        .map((d) => {
          let base = JSON.parse(Buffer.from(d.data, "base64"));
          switch (type) {
            case TYPE.TRANSACTION:
              if (res) {
                if (!res.locals.transaction) res.locals.transaction = {};
                res.locals.transaction[base.address] = new Transaction(base);
              }
              return new Transaction(base).toObject(
                removeSignature,
                removeType
              );
            case TYPE.USER:
              if (res) {
                if (!res.locals.user) res.locals.user = {};
                res.locals.user[base.address] = new User(base);
              }
              return new User(base).toObject(removeSignature, removeType);
          }
        })
        .flatten()
        .value();
      logFormatted(
        `${source} | Querying all ${assetName}s - ${
          assetList.length
        } ${assetName}${assetList.length !== 1 ? "s" : ""} found`,
        assetList.length === 0 ? SEVERITY.ERROR : SEVERITY.SUCCESS
      );
      return assetList;
    });
};

/**
 * Creates an array of assets (namely transactions) for the Sawtooth REST API.
 *
 * @param {Array} inputs - Array of addresses that are the inputs (read access) of the transaction.
 * @param {Array} outputs - Array of addresses that are the outputs (write access) of the transaction.
 * @param {String} payload - JSON stringified object to insert into the blockchain. (Must include {func, args: {transaction, txid}})
 * @returns {Array} Array of assets (namely transactions) for the Sawtooth REST API.
 */
const buildBatch = ({ inputs, outputs, payload }, ...args) => {
  let transactions = [
    new Asset({
      inputs,
      outputs,
      payload,
    }),
  ];
  // eslint-disable-next-line no-unused-vars
  (args || []).forEach((transaction) =>
    transactions.push(buildBatch(transaction))
  );

  return [].concat.apply([], transactions);
};

/**
 * Puts an asset in the blockchain.
 *
 * @param {String} type - Type of asset, such as TRANSACTION or USER ( @see TYPE ).
 * @param {String} httpMethod - PUT or POST (defined in TYPE constants).
 * @param {String} source - Endpoint source that invoked function (used for logging).
 * @param {BaseModel} object - Asset object.
 * @returns {Promise}  Promise of the batch post request. If successfully resolved, contains responseCode, msg, payload
 */
const _putAsset = (type, httpMethod, source, object) => {
  let asset;
  let txid;
  let assetAddress;
  let assetName;

  switch (type) {
    case TYPE.TRANSACTION:
      assetName = "Transaction";
      txid = object.signature;
      asset = object.toString(false, false);
      assetAddress = getTransactionAddress(txid);
      break;

    case TYPE.USER:
      assetName = "User";
      txid = object.address;
      asset = object.toString(true, false);
      assetAddress = getUserAddress(txid);
      break;
  }
  const assetPayload = JSON.stringify({
    func: httpMethod.toLowerCase(),
    args: { transaction: asset, txid },
  });

  const batch = buildBatch({
    payload: assetPayload,
    inputs: [assetAddress],
    outputs: [assetAddress],
  });

  logFormatted(`${source} | BATCH Request:`, SEVERITY.NOTIFY, ...batch);

  return sendTransaction(batch).then((sawtoothResponse) => {
    logFormatted(
      `${source}  | BATCH Response: ${sawtoothResponse.status} - ${sawtoothResponse.statusText}`,
      SEVERITY.SUCCESS
    );
    const responseCode = httpMethod === HTTP_METHODS.POST ? 201 : 200;
    const responseMessage = `${assetName} ${
      httpMethod === HTTP_METHODS.POST ? "created" : "updated"
    }`;
    const objResponse = JSON.parse(asset);
    delete objResponse.type;
    return { responseCode, msg: responseMessage, payload: objResponse };
  });
};

/**
 * Builds a transaction of an asset (User, Transaction, etc).
 *
 * @param {String} type - Type of asset, such as TRANSACTION or USER ( @see TYPE ).
 * @param {String} httpMethod - PUT or POST ( @see HTTP_METHODS ).
 * @param {BaseModel} object - Asset object ( @see Transaction , @see User )
 * @returns {Asset} Asset (namely a transaction) of the Sawtooth REST API.
 */
const buildAssetTransaction = (type, httpMethod, object) => {
  let asset;
  let txid;
  let assetAddress;

  switch (type) {
    case TYPE.TRANSACTION:
      txid = object.signature;
      asset = object.toString(false, false);
      assetAddress = getTransactionAddress(txid);
      break;

    case TYPE.USER:
      txid = object.address;
      asset = object.toString(true, false);
      assetAddress = getUserAddress(txid);
      break;
  }
  const assetPayload = JSON.stringify({
    func: httpMethod.toLowerCase(),
    args: { transaction: asset, txid },
  });

  return new Asset({
    payload: assetPayload,
    inputs: [assetAddress],
    outputs: [assetAddress],
  });
};

/**
 * Puts a batch of assets into the blockchain.
 *
 * @param {String} httpMethod - PUT or POST ( @see HTTP_METHODS ).
 * @param {String} source - Endpoint source that invoked function (used for logging).
 * @param {Object} arrayOfAssets - Array of assets to be inserted into the blockchain.
 * @returns {Promise} Promise of the batch post request. If successfully resolved, contains responseCode, msg, payload
 */
const putBatch = (httpMethod, source, arrayOfAssets) => {
  const batch = buildBatch(...arrayOfAssets);

  logFormatted(`${source} | BATCH Request:`, SEVERITY.NOTIFY, ...batch);
  return sendTransaction(batch).then((sawtoothResponse) => {
    logFormatted(
      `${source} | BATCH Response: ${sawtoothResponse.status} - ${sawtoothResponse.statusText}`,
      SEVERITY.SUCCESS
    );
    const responseCode = httpMethod === HTTP_METHODS.POST ? 201 : 200;
    const responseMessage = `Batch of ${arrayOfAssets.length} transaction${
      arrayOfAssets.length > 1 ? "s" : ""
    } ${httpMethod === HTTP_METHODS.POST ? "created" : "updated"}`;
    const arrayOfPayloads = [];
    batch.forEach((transaction) => {
      const payload = JSON.parse(transaction.payload);
      delete payload.type;
      arrayOfPayloads.push(payload);
    });

    return { responseCode, msg: responseMessage, payload: arrayOfPayloads };
  });
};

//#endregion

//#region [Express.js REQUEST HANDLERS]

/**
 * Puts an asset in the blockchain.
 *
 * @param {String} type - Type of asset, such as TRANSACTION or USER ( @see TYPE ).
 * @param {String} httpMethod - PUT or POST ( @see HTTP_METHODS ).
 * @param {String} source - Endpoint source that invoked function (used for logging).
 * @param {Object} req - Http request object.
 * @param {Object} res - Response object to handle Express request.
 * @return {Promise} Promise of the Sawtooth REST API request response.
 * @throws {Error} If Sawtooth REST API rejects the request.
 */
const putAsset = (type, httpMethod, source, req, res) => {
  let asset;
  switch (type) {
    case TYPE.USER:
      asset = new User(req.body);
      break;
  }
  return _putAsset(type, httpMethod, source, asset)
    .then(({ responseCode, msg, payload }) => {
      return res.status(responseCode).json({ msg, payload });
    })
    .catch((err) => {
      logFormatted(`${source} | BATCH Response: ${err}`, SEVERITY.ERROR);
      return res.status(500).json({ err });
    });
};

//#endregion

module.exports.hash512 = hash512;
module.exports.getTransactionAddress = getTransactionAddress;
module.exports.getUserAddress = getUserAddress;
module.exports.findByAddress = findByAddress;
module.exports.findAllAssets = findAllAssets;
module.exports._putAsset = _putAsset;
module.exports.buildAssetTransaction = buildAssetTransaction;
module.exports.putBatch = putBatch;
module.exports.putAsset = putAsset;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
