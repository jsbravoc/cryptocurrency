/*! cryptocurrency 2021-05-20 */
const chai=require("chai"),should=chai.should(),_=require("lodash");chai.use(require("chai-http"));const{randomBytes}=require("crypto"),{v4:uuidv4}=require("uuid"),API_URL=require("../app"),User=require("../models/User"),Transaction=require("../models/Transaction"),CRYPTO_ENDPOINT="/cryptocurrency",ENFORCER_ENDPOINT="/validate",USERS_ENDPOINT="/users",{expect}=chai,secp256k1=require("secp256k1"),ethers=require("ethers"),users={W1000:new User({address:uuidv4()}),W0:new User({address:uuidv4()}),NoCoinbase:new User({address:uuidv4()}),CantTransferW1000:new User({address:uuidv4()}),ToDeleteW1000:new User({address:uuidv4()}),Inactive:new User({address:uuidv4()})},createdVariables={transactions:{user:{[users.W1000.address]:{},[users.W0.address]:{},[users.NoCoinbase.address]:{},[users.CantTransferW1000.address]:{},[users.ToDeleteW1000.address]:{},[users.Inactive.address]:{}},transaction:{[users.W1000.address]:{},[users.W0.address]:{},[users.NoCoinbase.address]:{},[users.CantTransferW1000.address]:{},[users.ToDeleteW1000.address]:{},[users.Inactive.address]:{}}}};for(const a in users)if(Object.hasOwnProperty.call(users,a)){const b=users[a];let e;for(;e=randomBytes(32),!secp256k1.privateKeyVerify(e););const d=secp256k1.publicKeyCreate(e);b.public_key=Buffer.from(d).toString("hex"),b.private_key=Buffer.from(e).toString("hex")}const getSignature=(e,t,s=!0)=>{let r,a;a=s?(r=new Transaction(t),r.toSignatureString()):JSON.stringify(t);e=e.private_key;try{var o="Ethereum Signed Message:\n"+a.length+a;const i=ethers.utils.keccak256("0x"+Buffer.from(o).toString("hex"));var n=secp256k1.ecdsaSign(Buffer.from(i.slice(2),"hex"),Buffer.from(e,"hex"));return"0x"+Buffer.from(n.signature).toString("hex")+(n.recid+27).toString(16)}catch(e){return new Error(e.message)}},createUser=({alias:s,coinbasePermission:e=!0,transferToPermissions:t=null,active:r=!0,returnTo:a=null,callback:o=null})=>{const n={};var{address:i,public_key:c}=users[s];const d={address:i,public_key:c};return a&&(d.return_to=a),e&&(n.coinbase=!0),"boolean"==typeof r&&(d.active=r),t&&(n.transfer_to=t),d.permissions=n,chai.request(API_URL).post(`${USERS_ENDPOINT}`).send(d).end(function(e,t){return o({err:e,res:t,alias:s})}),!0},createTransaction=({recipientAlias:s,amount:r,pending:a,signature:e=null,senderAlias:o=null,creatorAlias:t=null,callback:n=null,valid_thru:i=null,description:c=null})=>{var d;const u={recipient:users[s]?users[s].address:s,amount:r};"boolean"==typeof a&&(u.pending=a),i&&(u.valid_thru=i),c&&(u.description=c),o&&(d=users[o]?users[o].address:o,u.sender=d),t&&(d=users[t]?users[t].address:t,u.creator=d);let l;return users[t]?l=getSignature(users[t],u):users[o]?l=getSignature(users[o],u):users[s]&&(l=getSignature(users[s],u)),u.signature=l||e||uuidv4(),""===e&&(u.signature=""),chai.request(API_URL).post(`${CRYPTO_ENDPOINT}`).send(u).end(function(e,t){return n({err:e,res:t,recipientAlias:s,senderAlias:o,amount:r,pending:a,signature:u.signature})}),!0};describe("Cryptocurrency Test Suite",()=>{before(function(i){this.timeout(2e4);const n=({res:e,alias:t,callback:s})=>{const r=users[t].address;return console.log(e.body),expect(e).to.satisfy(e=>(createdVariables.transactions.user[r]=e.body,201===e.statusCode&&(console.log(`[Before hook]: User ${t} created with address: ${r}`),s&&s(e),!0)))},c=({recipientAlias:t,senderAlias:s,amount:r,pending:a,signature:o,res:e,callback:n})=>{const i=users[t].address,c=users[s]?users[s].address:void 0;return expect(e).to.satisfy(e=>(!s&&i?createdVariables.transactions.transaction[i].coinbase=e.body:"boolean"==typeof a&&c?createdVariables.transactions.transaction[c].pending=e.body:createdVariables.transactions.transaction[c][t]=e.body,201===e.statusCode&&(s?console.log(`[Before hook]: User ${s} sent${!0===a?" pending ":" "}transaction of ${r} CNKs to ${t}, with signature: ${o}`):console.log(`[Before hook]: User ${t} received ${r} CNKs, with signature: ${o}`),n&&n(e),!0)))};createUser({alias:"W1000",coinbasePermission:!0,callback:n}),createUser({alias:"W0",coinbasePermission:!0,callback:n}),createUser({alias:"NoCoinbase",coinbasePermission:!1,callback:n}),createUser({alias:"Inactive",coinbasePermission:!0,active:!1,callback:n}),createUser({alias:"CantTransferW1000",coinbasePermission:!0,transferToPermissions:{[users.W1000.address]:!1},callback:n}),setTimeout(()=>{createTransaction({recipientAlias:"W1000",amount:1e3,callback:({err:e,res:t,recipientAlias:s,senderAlias:r,amount:a,signature:o})=>c({recipientAlias:s,senderAlias:r,amount:a,signature:o,err:e,res:t,callback:()=>setTimeout(()=>{createUser({alias:"ToDeleteW1000",coinbasePermission:!0,returnTo:{default:users.W1000.address,inactive:users.Inactive.address},callback:n}),createTransaction({recipientAlias:"CantTransferW1000",amount:1e3,callback:({err:e,res:t,recipientAlias:s,senderAlias:r,amount:a,signature:o})=>c({recipientAlias:s,senderAlias:r,amount:a,signature:o,err:e,res:t,callback:()=>{setTimeout(()=>{createTransaction({senderAlias:"CantTransferW1000",recipientAlias:"W0",amount:1,callback:c})},2500)}})}),createTransaction({recipientAlias:"W0",amount:600,pending:!0,senderAlias:"W1000",creatorAlias:"W1000",callback:({err:e,res:t,recipientAlias:s,senderAlias:r,amount:a,signature:o,pending:n})=>c({recipientAlias:s,senderAlias:r,amount:a,signature:o,pending:n,err:e,res:t,callback:()=>setTimeout(i,5e3)})})},2500)})})},2500)}),describe(`${CRYPTO_ENDPOINT} Tests`,()=>{describe(`GET ${CRYPTO_ENDPOINT}`,()=>{describe("Successful requests",()=>{describe("Get all transactions (non expanded)",()=>{it("Non expanded transactions should be returned",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}`).query({limit:5}).end(function(e,t){expect(t.body).to.be.an("array"),expect(t).to.have.status(200),t.body.forEach(e=>{(e.supporting_transactions||[]).forEach(e=>{expect(e).to.be.a("string")})}),s()})})}),describe("Get all transactions (expanded)",()=>{it("All transactions returned should be expanded",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}`).query({expanded:!0,limit:5}).end(function(e,t){expect(t.body).to.be.an("array"),expect(t).to.have.status(200),t.body.forEach(e=>{(e.supporting_transactions||[]).forEach(e=>{expect(e).to.be.an("object")})}),s()})})}),describe("Get all transactions (hide pending)",()=>{it("All transactions except those which are pending should be returned",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}`).query({limit:5,hidePending:!0}).end(function(e,t){expect(t.body).to.be.an("array"),expect(t).to.have.status(200),t.body.forEach(e=>{void 0!==e.pending&&expect(e.pending).to.equal(!1)}),s()})})}),describe("Get all transactions (hide invalid)",()=>{it("All transactions except those which are invalid should be returned",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}`).query({limit:5,hideInvalid:!0}).end(function(e,t){expect(t.body).to.be.an("array"),expect(t).to.have.status(200),t.body.forEach(e=>{expect(e.valid).to.equal(!0)}),s()})})})})}),describe(`GET ${CRYPTO_ENDPOINT}/:address`,()=>{describe("Transaction error validations",()=>{describe("Value validation",()=>{it("Non existent transaction should throw an error",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/${uuidv4()}`).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})}),it("Empty transaction signature should throw an error",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/      /`).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})})})}),describe("Transaction success validations",function(){it("Transaction should be retrieved successfully",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/${createdVariables.transactions.transaction[users.W1000.address].coinbase.payload.signature}`).end(function(e,t){expect(t).to.have.status(200),s()})}),it("Transaction should be retrieved and expanded successfully",s=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/${createdVariables.transactions.transaction[users.CantTransferW1000.address].W0.payload.signature}`).query({expanded:!0}).end(function(e,t){expect(t).to.have.status(200),(t.body.supporting_transactions||[]).forEach(e=>{expect(e).to.be.an("object")}),s()})})})}),describe(`POST ${CRYPTO_ENDPOINT}`,()=>{describe("Transaction errors validations",()=>{describe("Empty values",()=>{it("Empty request should throw an error",s=>{chai.request(API_URL).post(`${CRYPTO_ENDPOINT}`).send({}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})}),it("Empty recipient should throw an error",s=>{chai.request(API_URL).post(`${CRYPTO_ENDPOINT}`).send({amount:10,sender:"Anyone",signature:"Anything"}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"recipient",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Empty amount should throw an error",t=>{createTransaction({senderAlias:"Anyone",recipientAlias:"Another User",callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"amount",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Empty signature should throw an error",t=>{createTransaction({senderAlias:"Anyone",recipientAlias:"Another User",amount:10,signature:"",callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"signature",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})})}),describe("Value validation",()=>{it("Negative transaction amount should throw an error",t=>{createTransaction({senderAlias:"Anyone",recipientAlias:"Another User",amount:-10,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"amount",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Valid thru transaction date without ISO 8061 format should throw an error",t=>{createTransaction({senderAlias:"Anyone",recipientAlias:"Another User",amount:10,valid_thru:"2021-17-04",callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"valid_thru",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Past valid thru transaction date should throw an error",t=>{createTransaction({senderAlias:"Anyone",recipientAlias:"Another User",amount:10,valid_thru:"2021-04-17T03:42:03.642Z",callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"valid_thru",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})})}),describe("Transaction validation",()=>{it("Transaction signature that cannot be decrypted should throw an error",s=>{chai.request(API_URL).post(`${CRYPTO_ENDPOINT}`).send({amount:10,recipient:users.W1000.address,signature:createdVariables.transactions.transaction[users.CantTransferW1000.address].W0.payload.signature+"1"}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"signature",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Transaction signature that isn't signed by creator user throw an error",s=>{var e=getSignature(users.CantTransferW1000,{amount:10,recipient:users.W1000.address});chai.request(API_URL).post(`${CRYPTO_ENDPOINT}`).send({amount:10,recipient:users.W1000.address,signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"signature",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Transaction signature that doesn't match with its contents should throw an error",s=>{var e=getSignature(users.W1000,{amount:100,recipient:users.W1000.address});chai.request(API_URL).post(`${CRYPTO_ENDPOINT}`).send({amount:10,recipient:users.W1000.address,signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"signature",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Non existing sender should throw an error",t=>{createTransaction({senderAlias:uuidv4(),recipientAlias:"W1000",amount:10,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"sender",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Non existing recipient should throw an error",t=>{createTransaction({senderAlias:"W1000",recipientAlias:uuidv4(),amount:10,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"recipient",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Inactive recipient should throw an error",t=>{createTransaction({senderAlias:"W1000",recipientAlias:"Inactive",amount:1,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"recipient",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Insufficient balance should throw an error",t=>{createTransaction({senderAlias:"W1000",recipientAlias:"W0",amount:1e308,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"amount",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Insufficient balance due to pending transaction should throw an error",t=>{createTransaction({senderAlias:"W1000",recipientAlias:"W0",amount:650,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"amount",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Coinbase transaction without permissions should throw an error",t=>{createTransaction({recipientAlias:"NoCoinbase",amount:650,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"recipient",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})}),it("Transfer to explicitly denied recipient should throw an error",t=>{createTransaction({recipientAlias:"W1000",senderAlias:"CantTransferW1000",amount:100,callback:({res:e})=>{expect(e.body.errors).to.be.an("array"),expect(_.some(e.body.errors,{param:"sender",location:"body"})).to.be.true,expect(e).to.have.status(400),t()}})})})}),describe("Transaction success validations",function(){this.slow(15e3),this.timeout(2e4),it("Transaction should be created successfully",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"W0",callback:({res:e})=>{expect(e).to.have.status(201),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W0.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(2),s()})},3500)}})}),it("Pending valid thru transaction should be created successfully",s=>{const e=new Date;e.setSeconds(e.getSeconds()+5),createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"W0",valid_thru:e.toISOString(),pending:!0,description:"Expiring transaction",callback:({res:e})=>{createdVariables.transactions.transaction[users.W1000.address].expiringTransaction=e.body.payload,expect(e).to.have.status(201),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W0.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(2),s()})},3500)}})}),it("Pending transaction should not change user's balance",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"W0",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W0.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(2),s()})},3500)}})}),it("Valid thru transaction should be created successfully",s=>{const e=new Date;e.setSeconds(e.getSeconds()+5),createTransaction({amount:25,senderAlias:"CantTransferW1000",recipientAlias:"ToDeleteW1000",valid_thru:e.toISOString(),description:"Expiring valid transaction",callback:({res:e})=>{createdVariables.transactions.transaction[users.CantTransferW1000.address].expiringTransaction=e.body.payload,expect(e).to.have.status(201),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(25),s()})},3500)}})})})}),describe(`PUT ${CRYPTO_ENDPOINT}/:address`,()=>{describe("Transaction error validations",()=>{describe("Value validation",()=>{it("Non existent transaction should throw an error",s=>{chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${uuidv4()}`).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})})}),describe("Transaction validation",function(){this.slow(9e3),this.timeout(12e3),it("Non pending transaction should throw an error",s=>{chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${createdVariables.transactions.transaction[users.W1000.address].coinbase.payload.signature}`).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})}),it("Approval signature that isn't signed by sender user throw an error",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.ToDeleteW1000,{approve:!0},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).query({approve:!0,signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})},3500)}})}),it("Approval signature that cannot be decrypted should throw an error",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{approve:!0},!1)+"1";chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).query({approve:!0,signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})},3500)}})}),it("Approval signature that doesn't match with its contents should throw an error",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{approve:!1},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).query({approve:!0,signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})},3500)}})}),it("Update description signature that cannot be decrypted should throw an error",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",description:"A description",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{description:"Another description"},!1)+"1";chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).send({description:"Another description",signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})},3500)}})}),it("Update description signature that doesn't match with its contents should throw an error",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",description:"A description",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{description:"Another description"},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).send({description:"Different description",signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})},3500)}})}),it("Update description signature that isn't signed by creator or sender throw an error",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",description:"A description",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.ToDeleteW1000,{description:"Another description"},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).send({description:"Another description",signature:e}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})},3500)}})})})}),describe("Transaction success validations",function(){this.slow(2e4),this.timeout(25e3),it("Transaction should be approved successfully",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{approve:!0},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).query({approve:!0,signature:e}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(26),s()})},3500)})},3500)}})}),it("Transaction should be rejected successfully",s=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"NoCoinbase",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const t=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{approve:!1},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${t.signature}`).query({approve:!1,signature:e}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.NoCoinbase.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(0),s()})},3500)})},3500)}})}),it("Transaction should be updated successfully",r=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"NoCoinbase",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const s=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{description:"New description"},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${s.signature}`).send({description:"New description",signature:e}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/${s.signature}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("description").equal("New description"),r()})},3500)})},3500)}})}),it("Transaction should be approved & updated successfully",r=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"ToDeleteW1000",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const s=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{approve:!0,description:"New description"},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${s.signature}`).query({approve:!0}).send({description:"New description",signature:e}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(27),chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/${s.signature}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("description").equal("New description"),r()})})},3500)})},3500)}})}),it("Transaction should be rejected & updated successfully",r=>{createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"NoCoinbase",pending:!0,callback:({res:e})=>{expect(e).to.have.status(201);const s=e.body.payload;setTimeout(()=>{var e=getSignature(users.W1000,{approve:!1,description:"New description"},!1);chai.request(API_URL).put(`${CRYPTO_ENDPOINT}/${s.signature}`).query({approve:!1}).send({description:"New description",signature:e}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.NoCoinbase.address}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("balance").equal(0),chai.request(API_URL).get(`${CRYPTO_ENDPOINT}/${s.signature}`).end(function(e,t){expect(t).to.have.status(200),t.body.should.have.property("description").equal("New description"),r()})})},3500)})},3500)}})})})})}),describe(`${ENFORCER_ENDPOINT} Tests`,()=>{describe(`POST ${ENFORCER_ENDPOINT}`,()=>{describe(`POST ${ENFORCER_ENDPOINT}?users={users}&transactions={transactions}`,()=>{describe("Enforcer success validations",function(){this.slow(2e4),this.timeout(25e3),it("Expiring lastest transactions should be deleted successfully",s=>{const e=new Date;e.setSeconds(e.getSeconds()+2),createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"W0",valid_thru:e.toISOString(),description:"Expiring valid transaction",callback:({res:e})=>{createdVariables.transactions.transaction[users.W1000.address].expiringTransactionToW0=e.body.payload,expect(e).to.have.status(201),setTimeout(()=>{chai.request(API_URL).post(`${ENFORCER_ENDPOINT}`).query({users:`${users.W0.address}`,transactions:`${createdVariables.transactions.transaction[users.W1000.address].expiringTransactionToW0.signature}`}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W0.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body.lastest_transactions).to.be.an("array").that.does.not.include(createdVariables.transactions.transaction[users.W1000.address].expiringTransactionToW0.signature),t.body.should.have.property("balance").equal(2),s()})},5e3)})},2500)}})}),it("Non expiring lastest transactions should not be deleted",s=>{const e=new Date;e.setSeconds(e.getSeconds()+60),createTransaction({amount:1,senderAlias:"W1000",recipientAlias:"W0",valid_thru:e.toISOString(),description:"Expiring valid transaction",callback:({res:e})=>{createdVariables.transactions.transaction[users.W1000.address].nonExpiringTransactionToW0=e.body.payload,expect(e).to.have.status(201),setTimeout(()=>{chai.request(API_URL).post(`${ENFORCER_ENDPOINT}`).query({users:`${users.W0.address}`,transactions:`${createdVariables.transactions.transaction[users.W1000.address].nonExpiringTransactionToW0.signature}`}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W0.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body.lastest_transactions).to.be.an("array").that.does.include(createdVariables.transactions.transaction[users.W1000.address].nonExpiringTransactionToW0.signature),t.body.should.have.property("balance").equal(3),s()})},5e3)})},2500)}})})})}),describe(`POST ${ENFORCER_ENDPOINT}?users={users}`,()=>{describe("Enforcer success validations",function(){this.slow(15e3),this.timeout(2e4),it("Pending valid thru transaction should be deleted successfully",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W1000.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body.pending_transactions).to.be.an("array").that.does.include(createdVariables.transactions.transaction[users.W1000.address].expiringTransaction.signature),chai.request(API_URL).post(`${ENFORCER_ENDPOINT}`).query({users:`${users.W1000.address},${users.W0.address}`}).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W1000.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body.pending_transactions).to.be.an("array").that.does.not.include(createdVariables.transactions.transaction[users.W1000.address].expiringTransaction.signature),s()})},5e3)})})})})}),describe("Enforcer success validations",function(){this.slow(2e4),this.timeout(3e4),it("Expiring lastest transactions should be deleted successfully",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body.lastest_transactions).to.be.an("array").that.does.include(createdVariables.transactions.transaction[users.CantTransferW1000.address].expiringTransaction.signature),chai.request(API_URL).post(`${ENFORCER_ENDPOINT}`).end(function(e,t){expect(t).to.have.status(200),setTimeout(()=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body.lastest_transactions).to.be.an("array").that.does.not.include(createdVariables.transactions.transaction[users.CantTransferW1000.address].expiringTransaction.signature),expect(t.body.balance).to.equal(2),s()})},5e3)})})})})})}),describe(`${USERS_ENDPOINT} Tests`,()=>{describe(`GET ${USERS_ENDPOINT}`,()=>{describe("Successful requests",()=>{describe("Get all users (non expanded)",()=>{it("Non expanded users should be returned",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}`).query({limit:5}).end(function(e,t){expect(t.body).to.be.an("array"),expect(t).to.have.status(200),s()})})}),describe("Get all users (expanded)",function(){this.slow(1500),this.timeout(5e3),it("All users returned should be expanded",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}`).query({expanded:!0,limit:5}).end(function(e,t){expect(t.body).to.be.an("array"),expect(t).to.have.status(200),s()})})})})}),describe(`GET ${USERS_ENDPOINT}/:address`,()=>{describe("User error validations",()=>{describe("Value validation",()=>{it("Non existent user should throw an error",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${uuidv4()}`).end(function(e,t){expect(t).to.have.status(400),s()})}),it("Empty user address should throw an error",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/      /`).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})})})}),describe("User success validations",function(){it("User should be retrieved successfully",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W1000.address}`).end(function(e,t){expect(t).to.have.status(200),expect(t.body).to.be.an("object"),s()})}),it("User should be retrieved and expanded successfully",s=>{chai.request(API_URL).get(`${USERS_ENDPOINT}/${users.W1000.address}`).query({expanded:!0}).end(function(e,t){expect(t).to.have.status(200);new User(t.body);expect(t.body).to.be.an("object"),s()})})})}),describe(`POST ${USERS_ENDPOINT}`,()=>{describe("User errors validations",()=>{describe("Empty values",()=>{it("Empty request should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(t).to.have.status(400),s()})}),it("Empty address should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({public_key:uuidv4()}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"address",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Empty public_key should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:uuidv4()}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"public_key",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})}),describe("Value validation",()=>{it("Permission value that is not boolean should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:uuidv4(),public_key:uuidv4(),permissions:{coinbase:"TRUE"}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"permissions",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Nested permissions value (transfer_to) that is not boolean should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:uuidv4(),public_key:uuidv4(),permissions:{transfer_to:{[users.W1000.address]:["true"]}}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"permissions",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Return_to value that is not string should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:uuidv4(),public_key:uuidv4(),permissions:{coinbase:!0},return_to:{default:[uuidv4()]}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"return_to",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})}),describe("User validation",()=>{it("Already existing user with same address should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:users.W1000.address,public_key:users.W1000.address}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"address",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Return_to user that does not exist should throw an error",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:uuidv4(),public_key:uuidv4(),permissions:{coinbase:!0},return_to:{default:uuidv4()}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"return_to",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})})}),describe("User success validations",function(){this.slow(15e3),this.timeout(2e4),it("User should be created successfully",s=>{chai.request(API_URL).post(`${USERS_ENDPOINT}`).send({address:uuidv4(),public_key:uuidv4(),permissions:{coinbase:!0}}).end(function(e,t){expect(t).to.have.status(201),s()})})})}),describe(`PUT ${USERS_ENDPOINT}`,()=>{describe("User errors validations",()=>{describe("Value validation",()=>{it("Permission value that is not boolean should throw an error",s=>{chai.request(API_URL).put(`${USERS_ENDPOINT}/${users.W1000.address}`).send({permissions:{coinbase:"TRUE"}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"permissions",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Nested permissions value (transfer_to) that is not boolean should throw an error",s=>{chai.request(API_URL).put(`${USERS_ENDPOINT}/${users.W1000.address}`).send({permissions:{transfer_to:{[users.W1000.address]:["true"]}}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"permissions",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Return_to value that is not string should throw an error",s=>{chai.request(API_URL).put(`${USERS_ENDPOINT}/${users.W1000.address}`).send({permissions:{coinbase:!0},return_to:{default:[uuidv4()]}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"return_to",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})}),describe("User validation",()=>{it("Non existing user should throw an error",s=>{chai.request(API_URL).put(`${USERS_ENDPOINT}/${uuidv4()}`).send({permissions:{coinbase:!0}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"address",location:"params"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Return_to user that does not exist should throw an error",s=>{chai.request(API_URL).put(`${USERS_ENDPOINT}/${users.W1000.address}`).send({permissions:{coinbase:!0},return_to:{default:uuidv4()}}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"return_to",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})})}),describe("User success validations",function(){this.slow(15e3),this.timeout(2e4),it("User should be updated successfully",s=>{chai.request(API_URL).put(`${USERS_ENDPOINT}/${users.W1000.address}`).send({role:"New role",description:"Updated user",permissions:{coinbase:!0},return_to:{default:users.NoCoinbase.address}}).end(function(e,t){expect(t).to.have.status(200),s()})})})}),describe(`DELETE ${USERS_ENDPOINT}`,()=>{describe("User errors validations",()=>{describe("Value validation",()=>{it("Empty delete reason should throw an error",s=>{chai.request(API_URL).delete(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).send({}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"reason",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})}),describe("User validation",()=>{it("Non existing user should throw an error",s=>{chai.request(API_URL).delete(`${USERS_ENDPOINT}/${uuidv4()}`).send({reason:"default"}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"address",location:"params"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Non existing delete reason should throw an error",s=>{chai.request(API_URL).delete(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).send({reason:"undefined reason"}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"reason",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})}),it("Inactive delete reason user should throw an error",s=>{chai.request(API_URL).delete(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).send({reason:"inactive"}).end(function(e,t){expect(t.body.errors).to.be.an("array"),expect(_.some(t.body.errors,{param:"reason",location:"body"})).to.be.true,expect(t).to.have.status(400),s()})})})}),describe("User success validations",function(){this.slow(15e3),this.timeout(2e4),it("User should be deleted successfully",s=>{chai.request(API_URL).delete(`${USERS_ENDPOINT}/${users.ToDeleteW1000.address}`).send({reason:"default"}).end(function(e,t){expect(t).to.have.status(201),s()})})})})})});